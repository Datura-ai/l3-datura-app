#!/bin/bash

# React linting and formatting
echo "Linting and formatting React..."
cd apps/ui && yarn lint-staged && cd ../..

# FastAPI formatting with black and linting with flake8
staged_files=$(git diff --cached --name-only)

# Loop through each staged file
for file in $staged_files; do
    # Check if the file ends with .py
    if [[ $file == *.py ]]; then
        # Change to the directory where the pipenv environment is located
        cd apps/server

        # Adjust the file path since we changed directory
        relative_file=../../$file
        
        # Format the file with black and run ruff within the pipenv environment
        pipenv run black $relative_file
        pipenv run ruff check $relative_file --fix

        # Return to the root directory
        cd ../..

        # Check the exit status of ruff
        if [ $? -ne 0 ]; then
            echo "Ruff check failed for $file. Aborting commit."
            exit 1
        fi

        # Stage the formatted file
        git add $file
    fi
done

echo "Pre-commit checks passed!"
